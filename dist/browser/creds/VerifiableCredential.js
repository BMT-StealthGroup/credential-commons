"use strict";var _regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2);function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}var _=require("lodash"),Merkletools=require("merkle-tools"),sjcl=require("sjcl"),definitions=require("./definitions"),UCA=require("../uca/UserCollectableAttribute"),SecureRandom=require("../SecureRandom"),_require=require("../services"),services=_require.services,timestamp=require("unix-timestamp"),anchorService=services.container.AnchorService;function sha256(a){return sjcl.codec.hex.fromBits(sjcl.hash.sha256.hash(a))}function getClaimPath(a){var b=_.split(a,":"),c=_.lowerCase(b[1]);return c+"."+b[2]}function validIdentifiers(){var a=_.map(definitions,function(a){return a.identifier});return a}var CivicMerkleProof=function(){function a(b){(0,_classCallCheck3.default)(this,a);var c=a.padTree(b);this.type="CivicMerkleProof2018",this.merkleRoot=null,this.anchor="TBD (Civic Blockchain Attestation)",this.leaves=a.getAllAttestableValue(c),this.buildMerkleTree()}return(0,_createClass3.default)(a,null,[{key:"PADDING_INCREMENTS",get:function(){return 16}}]),(0,_createClass3.default)(a,[{key:"buildMerkleTree",value:function(){var a=this,b=new Merkletools,c=_.map(this.leaves,function(a){return sha256(a.value)});b.addLeaves(c),b.makeTree(),_.forEach(c,function(c,d){a.leaves[d].claimPath=getClaimPath(a.leaves[d].identifier),a.leaves[d].targetHash=c,a.leaves[d].proof=b.getProof(d)}),this.leaves=_.filter(this.leaves,function(a){return"civ:Random:node"!==a.identifier}),this.merkleRoot=b.getMerkleRoot().toString("hex")}}],[{key:"padTree",value:function(b){for(var c=b.length,d=c<a.PADDING_INCREMENTS?a.PADDING_INCREMENTS:_.ceil(c/a.PADDING_INCREMENTS)*a.PADDING_INCREMENTS,e=_.clone(b);e.length<d;)e.push(new UCA("civ:Random:node",SecureRandom.wordWith(16)));return e}},{key:"getAllAttestableValue",value:function(a){var b=[];return _.forEach(a,function(a){var c=a.getAttestableValues();_.reduce(c,function(a,b){return a.push(b),a},b)}),b}}]),a}(),ClaimModel=function a(b){var c=this;(0,_classCallCheck3.default)(this,a),_.forEach(b,function(a){var b=a.getClaimRootPropertyName();c[b]||(c[b]={}),c[b][a.getClaimPropertyName()]=a.getPlainValue()})};function VerifiableCredentialBaseConstructor(a,b,c,d,e){var f=this;this.id=null,this.issuer=b;var g=new UCA("civ:Meta:issuer",this.issuer);this.issued=new Date().toISOString();var h=new UCA("civ:Meta:issued",this.issued);this.identifier=a,this.expiry=c?timestamp.toDate(timestamp.now(c)).toISOString():null;var i=this.expiry?new UCA("civ:Meta:expiry",this.expiry):void 0,j=i?_.concat(d,g,h,i):_.concat(d,g,h);if(!_.includes(validIdentifiers(),a))throw new Error(a+" is not defined");var k=e?_.find(definitions,{identifier:a,version:""+e}):_.find(definitions,{identifier:a});if(!k)throw new Error("Credential definition for "+a+" v"+e+" not found");if(this.version=e||k.version,this.type=["Credential",a],this.claims=new ClaimModel(d),this.signature=new CivicMerkleProof(j),!_.isEmpty(k.excludes)){var l=_.remove(this.signature.leaves,function(a){return _.includes(k.excludes,a.identifier)});_.forEach(l,function(a){_.unset(f.claims,a.claimPath)})}return this.getGlobalCredentialItemIdentifier=function(){return"credential-"+f.identifier+"-"+f.version},this.filter=function(a){var b=_.cloneDeep(f);return _.remove(b.signature.leaves,function(b){return!_.includes(a,b.identifier)}),b.claims={},_.forEach(b.signature.leaves,function(a){_.set(b.claims,a.claimPath,_.get(f.claims,a.claimPath))}),b},this.requestAnchor=function(){var a=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function a(b){var c;return _regenerator2.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,anchorService.anchor(f.identifier,f.signature.merkleRoot,b);case 2:return c=a.sent,f.signature.anchor=c,a.abrupt("return",f);case 5:case"end":return a.stop();}},a,f)}));return function(){return a.apply(this,arguments)}}(),this.updateAnchor=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function a(){var b;return _regenerator2.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,anchorService.update(f.signature.anchor);case 2:return b=a.sent,f.signature.anchor=b,a.abrupt("return",f);case 5:case"end":return a.stop();}},a,f)})),this}module.exports=VerifiableCredentialBaseConstructor;