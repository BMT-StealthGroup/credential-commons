"use strict";var _regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2);function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}var _=require("lodash"),MerkleTools=require("merkle-tools"),sjcl=require("sjcl"),timestamp=require("unix-timestamp"),flatten=require("flat"),definitions=require("./definitions"),UCA=require("../uca/UserCollectableAttribute"),SecureRandom=require("../SecureRandom"),_require=require("../services"),services=_require.services,anchorService=services.container.AnchorService;function sha256(a){return sjcl.codec.hex.fromBits(sjcl.hash.sha256.hash(a))}function getClaimPath(a){var b=_.split(a,":"),c=_.lowerCase(b[1]);return c+"."+b[2]}function validIdentifiers(){var a=_.map(definitions,function(a){return a.identifier});return a}function getClaimsWithFlatKeys(a){var b=flatten(a,{maxDepth:3}),c=flatten(a,{maxDepth:2}),d=_.merge({},b,c),e=_(d).toPairs().sortBy(0).fromPairs().value();return e}function getLeavesClaimPaths(a){return _.map(a,"claimPath")}function verifyLeave(a,b,c,d,e,f,g){var h=new UCA(a.identifier,{attestableValue:a.value});if("String"===h.type||"Number"===h.type)h.value!==_.get(c,a.claimPath)&&e.push(a.value);else if("Object"===h.type){var i=h.value,j=_.get(c,a.claimPath),k=_.keys(h.value);_.each(k,function(a){var b=_.get(i[a],"type"),c="Number"===b?_.padStart(j[a],8,"0"):j[a];c&&_.get(i[a],"value")!==c&&e.push(j[a])})}else e.push(a.value);var l=sha256(a.value);l!==a.targetHash&&f.push(a.targetHash);var m=b.validateProof(a.node,a.targetHash,d.merkleRoot);m||g.push(a.targetHash)}var CivicMerkleProof=function(){function a(b){(0,_classCallCheck3.default)(this,a);var c=a.padTree(b);this.type="CivicMerkleProof2018",this.merkleRoot=null,this.anchor="TBD (Civic Blockchain Attestation)",this.leaves=a.getAllAttestableValue(c),this.buildMerkleTree()}return(0,_createClass3.default)(a,null,[{key:"PADDING_INCREMENTS",get:function(){return 16}}]),(0,_createClass3.default)(a,[{key:"buildMerkleTree",value:function(){var a=this,b=new MerkleTools,c=_.map(this.leaves,function(a){return sha256(a.value)});b.addLeaves(c),b.makeTree(),_.forEach(c,function(c,d){a.leaves[d].claimPath=getClaimPath(a.leaves[d].identifier),a.leaves[d].targetHash=c,a.leaves[d].node=b.getProof(d)}),this.leaves=_.filter(this.leaves,function(a){return"civ:Random:node"!==a.identifier}),this.merkleRoot=b.getMerkleRoot().toString("hex")}}],[{key:"padTree",value:function(b){for(var c=b.length,d=c<a.PADDING_INCREMENTS?a.PADDING_INCREMENTS:_.ceil(c/a.PADDING_INCREMENTS)*a.PADDING_INCREMENTS,e=_.clone(b);e.length<d;)e.push(new UCA("civ:Random:node",SecureRandom.wordWith(16)));return e}},{key:"getAllAttestableValue",value:function(a){var b=[];return _.forEach(a,function(a){var c=a.getAttestableValues();_.reduce(c,function(a,b){return a.push(b),a},b)}),b}}]),a}(),ClaimModel=function a(b){var c=this;(0,_classCallCheck3.default)(this,a),_.forEach(b,function(a){var b=a.getClaimRootPropertyName();c[b]||(c[b]={}),c[b][a.getClaimPropertyName()]=a.getPlainValue()})},VERIFY_LEVELS={INVALID:-1,PROOFS:0,ANCHOR:1,BLOCKCHAIN:2};function VerifiableCredentialBaseConstructor(a,b,c,d,e){var f=this;this.id=null,this.issuer=b;var g=new UCA("civ:Meta:issuer",this.issuer);this.issuanceDate=new Date().toISOString();var h=new UCA("civ:Meta:issuanceDate",this.issuanceDate);this.identifier=a,this.expirationDate=c?timestamp.toDate(timestamp.now(c)).toISOString():null;var i=new UCA("civ:Meta:expirationDate",this.expirationDate?this.expirationDate:"null"),j=i?_.concat(d,g,h,i):_.concat(d,g,h);if(!_.includes(validIdentifiers(),a))throw new Error(a+" is not defined");var k=e?_.find(definitions,{identifier:a,version:""+e}):_.find(definitions,{identifier:a});if(!k)throw new Error("Credential definition for "+a+" v"+e+" not found");if(this.version=""+e||k.version,this.type=["Credential",a],!_.isEmpty(d)&&(this.claim=new ClaimModel(d),this.proof=new CivicMerkleProof(j),!_.isEmpty(k.excludes))){var l=_.remove(this.proof.leaves,function(a){return _.includes(k.excludes,a.identifier)});_.forEach(l,function(a){_.unset(f.claim,a.claimPath)})}return this.getGlobalCredentialItemIdentifier=function(){return"credential-"+f.identifier+"-"+f.version},this.filter=function(a){var b=_.cloneDeep(f);return _.remove(b.proof.leaves,function(b){return!_.includes(a,b.identifier)}),b.claim={},_.forEach(b.proof.leaves,function(a){_.set(b.claim,a.claimPath,_.get(f.claim,a.claimPath))}),b},this.requestAnchor=function(){var a=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function a(b){var c;return _regenerator2.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,anchorService.anchor(f.identifier,f.proof.merkleRoot,b);case 2:return c=a.sent,f.proof.anchor=c,a.abrupt("return",f);case 5:case"end":return a.stop();}},a,f)}));return function(){return a.apply(this,arguments)}}(),this.updateAnchor=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function a(){var b;return _regenerator2.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,anchorService.update(f.proof.anchor);case 2:return b=a.sent,f.proof.anchor=b,a.abrupt("return",f);case 5:case"end":return a.stop();}},a,f)})),this.verifyProofs=function(){var a=_.clone(f.expirationDate),b=_.clone(f.claim),c=_.clone(f.proof),d=_.get(c,"leaves"),e=!1,g=new MerkleTools,h=getClaimsWithFlatKeys(b),i=getLeavesClaimPaths(d),j=[],k=[],l=[],m=[],n=[];_.forEach(_.keys(h),function(a){var e=_.indexOf(i,a);if(-1===e){_.findLastIndex(a,".");var f=a.substring(0,_.lastIndexOf(a,"."));if(-1<_.indexOf(i,f))return;j.push(a)}else{var h=d[e];verifyLeave(h,g,b,c,l,m,n)}});var o=_.indexOf(i,"meta.expirationDate");if(0<=o){var p=d[o],q=l.length+m.length+n.length;verifyLeave(p,g,{meta:{expirationDate:a}},c,l,m,n);var r=l.length+m.length+n.length;if(r===q&&null!==a){var s=new Date,t=new Date(a);s.getTime()>t.getTime()&&k.push(a)}}return _.isEmpty(j)&&_.isEmpty(l)&&_.isEmpty(m)&&_.isEmpty(n)&&_.isEmpty(k)&&(e=!0),e},this.verify=function(a){var b=a||VERIFY_LEVELS.PROOFS,c=VERIFY_LEVELS.INVALID;return b>=VERIFY_LEVELS.PROOFS&&f.verifyProofs()&&(c=VERIFY_LEVELS.PROOFS),c},this.verifySignature=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function a(){return _regenerator2.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",anchorService.verifySignature(f.proof));case 1:case"end":return a.stop();}},a,f)})),this.verifyAttestation=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function a(){return _regenerator2.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",anchorService.verifyAttestation(f.proof));case 1:case"end":return a.stop();}},a,f)})),this.revokeAttestation=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function a(){return _regenerator2.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",anchorService.revokeAttestation(f.proof));case 1:case"end":return a.stop();}},a,f)})),this.isRevoked=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function a(){return _regenerator2.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",anchorService.isRevoked(f.proof));case 1:case"end":return a.stop();}},a,f)})),this}VerifiableCredentialBaseConstructor.fromJSON=function(a){var b=new VerifiableCredentialBaseConstructor(a.identifier,a.issuer);return b.id=_.clone(a.id),b.issuanceDate=_.clone(a.issuanceDate),b.expirationDate=_.clone(a.expirationDate),b.identifier=_.clone(a.identifier),b.version=_.clone(a.version),b.type=_.cloneDeep(a.type),b.claim=_.cloneDeep(a.claim),b.proof=_.cloneDeep(a.proof),b},VerifiableCredentialBaseConstructor.VERIFY_LEVELS=VERIFY_LEVELS,module.exports=VerifiableCredentialBaseConstructor;