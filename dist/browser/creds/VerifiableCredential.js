"use strict";var _toConsumableArray2=require("babel-runtime/helpers/toConsumableArray"),_toConsumableArray3=_interopRequireDefault(_toConsumableArray2),_slicedToArray2=require("babel-runtime/helpers/slicedToArray"),_slicedToArray3=_interopRequireDefault(_slicedToArray2),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_typeof2=require("babel-runtime/helpers/typeof"),_typeof3=_interopRequireDefault(_typeof2),_keys=require("babel-runtime/core-js/object/keys"),_keys2=_interopRequireDefault(_keys);function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}var _=require("lodash"),sift=require("sift"),MerkleTools=require("merkle-tools"),sjcl=require("sjcl"),timestamp=require("unix-timestamp"),flatten=require("flat"),uuidv4=require("uuid/v4"),_require=require("../claim/Claim"),Claim=_require.Claim,definitions=require("./definitions"),_require2=require("../services"),services=_require2.services;function sha256(a){return sjcl.codec.hex.fromBits(sjcl.hash.sha256.hash(a))}function getClaimPath(a,b){var c=Claim.getPath(a),d=_.find(b,function(a){return _.endsWith(a,c)});return d||c}function validIdentifiers(){var a=_.map(definitions,function(a){return a.identifier});return a}function getClaimsWithFlatKeys(a){var b=flatten(a,{maxDepth:3}),c=flatten(a,{maxDepth:2}),d=_.merge({},b,c),e=_(d).toPairs().sortBy(0).fromPairs().value();return e}function paths(a){for(var b=[],c=[{obj:a,path:[]}],d=function(){var a=c.pop();(0,_keys2.default)(a.obj).forEach(function(d){if("object"===(0,_typeof3.default)(a.obj[d])){var e=a.path.concat(d);b.push(e),c.unshift({obj:a.obj[d],path:e})}})};0<c.length;)d();var e=[];return b.forEach(function(a){e.push(a.join("."))}),e}function getLeavesClaimPaths(a){return _.map(a,"claimPath")}function verifyLeave(a,b,c,d,e,f,g){var h=new Claim(a.identifier,{attestableValue:a.value});if("String"===h.type||"Number"===h.type)h.value!==_.get(c,a.claimPath)&&e.push(a.value);else if("Object"===h.type){var i=h.value,j=_.get(c,a.claimPath),k=_.keys(h.value);_.each(k,function(a){var b=j[a];b&&_.get(i[a],"value")!==b&&e.push(j[a])})}else e.push(a.value);var l=sha256(a.value);l!==a.targetHash&&f.push(a.targetHash);var m=b.validateProof(a.node,a.targetHash,d.merkleRoot);m||g.push(a.targetHash)}function transformConstraint(a){var b=[];return _.forEach(a.claims,function(a){if(!a.path)throw new Error("Malformed contraint: missing PATTH");if(!a.is)throw new Error("Malformed contraint: missing IS");var c={};c[a.path]=a.is,b.push(c)}),b}var CvcMerkleProof=function(){function a(b,c){(0,_classCallCheck3.default)(this,a);var d=a.padTree(b);this.type="CvcMerkleProof2018",this.merkleRoot=null,this.anchor="TBD (Civic Blockchain Attestation)",this.leaves=a.getAllAttestableValue(d),this.buildMerkleTree(c)}return(0,_createClass3.default)(a,null,[{key:"PADDING_INCREMENTS",get:function(){return 16}}]),(0,_createClass3.default)(a,[{key:"buildMerkleTree",value:function(a){var b=this,c=new MerkleTools,d=_.map(this.leaves,function(a){return sha256(a.value)});c.addLeaves(d),c.makeTree(),_.forEach(d,function(d,e){b.leaves[e].claimPath=getClaimPath(b.leaves[e].identifier,a),b.leaves[e].targetHash=d,b.leaves[e].node=c.getProof(e)}),this.leaves=_.filter(this.leaves,function(a){return"cvc:Random:node"!==a.identifier}),this.merkleRoot=c.getMerkleRoot().toString("hex")}}],[{key:"padTree",value:function(b){for(var c=b.length,d=c<a.PADDING_INCREMENTS?a.PADDING_INCREMENTS:_.ceil(c/a.PADDING_INCREMENTS)*a.PADDING_INCREMENTS,e=_.clone(b),f=services.container.SecureRandom;e.length<d;)e.push(new Claim("cvc:Random:node",f.wordWith(16)));return e}},{key:"getAllAttestableValue",value:function(a){var b=[];return _.forEach(a,function(a){var c=a.getAttestableValues();_.reduce(c,function(a,b){return a.push(b),a},b)}),b}}]),a}(),ClaimModel=function a(b){var c=this;(0,_classCallCheck3.default)(this,a),_.forEach(b,function(a){var b=a.getClaimRootPropertyName();c[b]||(c[b]={}),c[b][a.getClaimPropertyName()]=a.getPlainValue()})},VERIFY_LEVELS={INVALID:-1,PROOFS:0,ANCHOR:1,GRANTED:2,BLOCKCHAIN:3};function VerifiableCredentialBaseConstructor(a,b,c,d,e){var f=this;this.id=uuidv4(),this.issuer=b;var g=new Claim("cvc:Meta:issuer",this.issuer);this.issuanceDate=new Date().toISOString();var h=new Claim("cvc:Meta:issuanceDate",this.issuanceDate);this.identifier=a,this.expirationDate=c?timestamp.toDate(timestamp.now(c)).toISOString():null;var i=new Claim("cvc:Meta:expirationDate",this.expirationDate?this.expirationDate:"null"),j=i?_.concat(d,g,h,i):_.concat(d,g,h);if(!_.includes(validIdentifiers(),a))throw new Error(a+" is not defined");var k=e?_.find(definitions,{identifier:a,version:""+e}):_.find(definitions,{identifier:a});if(!k)throw new Error("Credential definition for "+a+" v"+e+" not found");if(this.version=""+e||k.version,this.type=["Credential",a],!_.isEmpty(d)){this.claim=new ClaimModel(d);var l=paths(this.claim),m=_.keys(flatten(this.claim,{safe:!0})),n=l.concat(m);if(this.proof=new CvcMerkleProof(j,n),!_.isEmpty(k.excludes)){var o=_.remove(this.proof.leaves,function(a){return _.includes(k.excludes,a.identifier)});_.forEach(o,function(a){_.unset(f.claim,a.claimPath)})}this.granted=null}return this.getGlobalCredentialItemIdentifier=function(){return"credential-"+f.identifier+"-"+f.version},this.filter=function(a){var b=_.cloneDeep(f);return _.remove(b.proof.leaves,function(b){return!_.includes(a,b.identifier)}),b.claim={},_.forEach(b.proof.leaves,function(a){_.set(b.claim,a.claimPath,_.get(f.claim,a.claimPath))}),b},this.requestAnchor=function(){var a=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function a(b){var c,d,e;return _regenerator2.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return c=services.container.AnchorService,d=_.merge({},b,{subject:{label:f.identifier,data:f.proof.merkleRoot}}),a.next=4,c.anchor(d);case 4:return e=a.sent,f.proof.anchor=e,a.abrupt("return",f);case 7:case"end":return a.stop();}},a,f)}));return function(){return a.apply(this,arguments)}}(),this.updateAnchor=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function a(){var b,c;return _regenerator2.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return b=services.container.AnchorService,a.next=3,b.update(f.proof.anchor);case 3:return c=a.sent,f.proof.anchor=c,a.abrupt("return",f);case 6:case"end":return a.stop();}},a,f)})),this.verifyProofs=function(){var a=_.clone(f.expirationDate),b=_.clone(f.claim),c=_.clone(f.proof),d=_.get(c,"leaves"),e=!1,g=new MerkleTools,h=getClaimsWithFlatKeys(b),i=getLeavesClaimPaths(d),j=[],k=[],l=[],m=[],n=[];_.forEach(_.keys(h),function(a){var e=_.indexOf(i,a);if(-1===e){_.findLastIndex(a,".");var f=a.substring(0,_.lastIndexOf(a,"."));if(-1<_.indexOf(i,f))return;j.push(a)}else{var h=d[e];verifyLeave(h,g,b,c,l,m,n)}});var o=_.indexOf(i,"meta.expirationDate");if(0<=o){var p=d[o],q=l.length+m.length+n.length;verifyLeave(p,g,{meta:{expirationDate:a}},c,l,m,n);var r=l.length+m.length+n.length;if(r===q&&null!==a){var s=new Date,t=new Date(a);s.getTime()>t.getTime()&&k.push(a)}}return _.isEmpty(j)&&_.isEmpty(l)&&_.isEmpty(m)&&_.isEmpty(n)&&_.isEmpty(k)&&(e=!0),e},this.verify=function(a,b){var c=b||{},d=c.requestorId,e=c.requestId,g=c.keyName,h=_.isNil(a)?VERIFY_LEVELS.GRANTED:a,i=VERIFY_LEVELS.INVALID;return i===VERIFY_LEVELS.INVALID&&h>=VERIFY_LEVELS.PROOFS&&f.verifyProofs()&&(i=VERIFY_LEVELS.PROOFS),i===VERIFY_LEVELS.PROOFS&&h>=VERIFY_LEVELS.ANCHOR&&f.verifyAttestation()&&(i=VERIFY_LEVELS.ANCHOR),i===VERIFY_LEVELS.ANCHOR&&h>=VERIFY_LEVELS.GRANTED&&f.verifyGrant(d,e,g)&&(i=VERIFY_LEVELS.GRANTED),i},this.verifySignature=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function a(){return _regenerator2.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",services.container.AnchorService.verifySignature(f.proof));case 1:case"end":return a.stop();}},a,f)})),this.verifyAttestation=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function a(){return _regenerator2.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",services.container.AnchorService.verifyAttestation(f.proof));case 1:case"end":return a.stop();}},a,f)})),this.revokeAttestation=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function a(){return _regenerator2.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",services.container.AnchorService.revokeAttestation(f.proof));case 1:case"end":return a.stop();}},a,f)})),this.isRevoked=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function a(){return _regenerator2.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",services.container.AnchorService.isRevoked(f.proof));case 1:case"end":return a.stop();}},a,f)})),this.isMatch=function(a){var b=transformConstraint(a),c=!0;return _.forEach(b,function(a){return c=-1<sift.indexOf(a,[f.claim]),c}),c},this.grantUsageFor=function(a,b,c){var d=c.keyName,e=c.pvtKey;if(_.isEmpty(_.get(f.proof,"anchor.subject.label"))||_.isEmpty(_.get(f.proof,"anchor.subject.pub")))throw new Error("Invalid credential attestation/anchor");if(!f.verifySignature())throw new Error("Invalid credential attestation/anchor signature");if(!a||!b||!(d||e))throw new Error("Missing required parameter: requestorId, requestId or key");var g=""+f.proof.anchor.subject.label+f.proof.anchor.subject.data+a+b,h=sha256(g),i=services.container.CryptoManager,j=d;if(e){if(!_.isFunction(i.installKey))throw new Error("You provide a `pvtKey` but the CryptoManager does not support it, use a `keyName` instead.");j="TEMP_KEY_NAME_"+new Date().getTime(),i.installKey(j,e)}var k=i.sign(j,h);f.granted=k},this.verifyGrant=function(a,b,c){var d=!1;if(_.isEmpty(_.get(f.proof,"anchor.subject.label"))||_.isEmpty(_.get(f.proof,"anchor.subject.pub")))return d;if(_.isEmpty(f.granted))return d;if(!a||!b)return d;var e=""+f.proof.anchor.subject.label+f.proof.anchor.subject.data+a+b,g=sha256(e),h=services.container.CryptoManager,i=c;if(_.isEmpty(i)){if(!_.isFunction(h.installKey))throw new Error("CryptoManager does not support intallKey, please use a `keyName` instead.");i="TEMP_KEY_NAME_"+new Date().getTime();var j=_.get(f.proof,"anchor.subject.pub");h.installKey(i,j)}return d=h.verify(i,g,f.granted),d},this}var CREDENTIAL_META_FIELDS=["id","identifier","issuer","issuanceDate","expirationDate","version","type"],getCredentialMeta=function(a){return _.pick(a,CREDENTIAL_META_FIELDS)};function transformMetaConstraint(a){var b={},c=_.get(a,"meta.credential");if(c){var d=/(.*)-(.*)-(.*)/g,e=d.exec(c),f=(0,_slicedToArray3.default)(e,4);b.identifier=f[2],b.version=f[3];var g=getCredentialMeta(a.meta);_.forEach(_.keys(g),function(a){b[a]=g[a].is})}return b}var isMatchCredentialMeta=function(a,b){var c=transformMetaConstraint(b),d=!1;return _.isEmpty(c)||(d=-1<sift.indexOf(c,[a])),d};VerifiableCredentialBaseConstructor.CREDENTIAL_META_FIELDS=CREDENTIAL_META_FIELDS,VerifiableCredentialBaseConstructor.getCredentialMeta=getCredentialMeta,VerifiableCredentialBaseConstructor.isMatchCredentialMeta=isMatchCredentialMeta,VerifiableCredentialBaseConstructor.fromJSON=function(a){var b=new VerifiableCredentialBaseConstructor(a.identifier,a.issuer);return b.id=_.clone(a.id),b.issuanceDate=_.clone(a.issuanceDate),b.expirationDate=_.clone(a.expirationDate),b.identifier=_.clone(a.identifier),b.version=_.clone(a.version),b.type=_.cloneDeep(a.type),b.claim=_.cloneDeep(a.claim),b.proof=_.cloneDeep(a.proof),b.granted=_.clone(a.granted)||null,b},VerifiableCredentialBaseConstructor.getAllProperties=function(a){var b=_.find(definitions,{identifier:a});if(b){var c=[];_.forEach(b.depends,function(a){c.push.apply(c,(0,_toConsumableArray3.default)(Claim.getAllProperties(a)))});var d=[];return _.forEach(b.excludes,function(a){d.push.apply(d,(0,_toConsumableArray3.default)(Claim.getAllProperties(a)))}),_.difference(c,d)}return null},VerifiableCredentialBaseConstructor.VERIFY_LEVELS=VERIFY_LEVELS,module.exports=VerifiableCredentialBaseConstructor;