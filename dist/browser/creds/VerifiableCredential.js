"use strict";var _createClass=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();function _asyncToGenerator(a){return function(){var b=a.apply(this,arguments);return new Promise(function(a,c){function d(e,f){try{var g=b[e](f),h=g.value}catch(a){return void c(a)}return g.done?void a(h):Promise.resolve(h).then(function(a){d("next",a)},function(a){d("throw",a)})}return d("next")})}}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _=require("lodash"),Merkletools=require("merkle-tools"),sjcl=require("sjcl"),definitions=require("./definitions"),UCA=require("../uca/UserCollectableAttribute"),SecureRandom=require("../SecureRandom"),_require=require("../services"),services=_require.services,anchorService=services.container.AnchorService;function sha256(a){return sjcl.codec.hex.fromBits(sjcl.hash.sha256.hash(a))}function getClaimPath(a){var b=_.split(a,":"),c=_.lowerCase(b[1]);return c+"."+b[2]}function validIdentifiers(){var a=_.map(definitions,function(a){return a.identifier});return a}var CivicMerkleProof=function(){function a(b){_classCallCheck(this,a);var c=a.padTree(b);this.type="CivicMerkleProof2018",this.merkleRoot=null,this.anchor="TBD (Civic Blockchain Attestation)",this.leaves=a.getAllAttestableValue(c),this.buildMerkleTree()}return _createClass(a,null,[{key:"PADDING_INCREMENTS",get:function(){return 16}}]),_createClass(a,[{key:"buildMerkleTree",value:function(){var a=this,b=new Merkletools,c=_.map(this.leaves,function(a){return sha256(a.value)});b.addLeaves(c),b.makeTree(),_.forEach(c,function(c,d){a.leaves[d].claimPath=getClaimPath(a.leaves[d].identifier),a.leaves[d].targetHash=c,a.leaves[d].proof=b.getProof(d)}),this.leaves=_.filter(this.leaves,function(a){return"civ:Random:node"!==a.identifier}),this.merkleRoot=b.getMerkleRoot().toString("hex")}}],[{key:"padTree",value:function(b){for(var c=b.length,d=c<a.PADDING_INCREMENTS?a.PADDING_INCREMENTS:_.ceil(c/a.PADDING_INCREMENTS)*a.PADDING_INCREMENTS,e=_.clone(b);e.length<d;)e.push(new UCA("civ:Random:node",SecureRandom.wordWith(16)));return e}},{key:"getAllAttestableValue",value:function(a){var b=[];return _.forEach(a,function(a){var c=a.getAttestableValues();_.reduce(c,function(a,b){return a.push(b),a},b)}),b}}]),a}(),ClaimModel=function a(b){var c=this;_classCallCheck(this,a),_.forEach(b,function(a){var b=a.getClaimRootPropertyName();c[b]||(c[b]={}),c[b][a.getClaimPropertyName()]=a.getPlainValue()})};function VerifiableCredentialBaseConstructor(a,b,c,d){var e=this;if(this.id=null,this.issuer=b,this.issued=new Date().toISOString(),this.identifier=a,!_.includes(validIdentifiers(),a))throw new Error(a+" is not defined");var f=d?_.find(definitions,{identifier:a,version:""+d}):_.find(definitions,{identifier:a});if(!f)throw new Error("Credential definition for "+a+" v"+d+" not found");if(this.version=d||f.version,this.type=["Credential",a],this.claims=new ClaimModel(c),this.signature=new CivicMerkleProof(c),!_.isEmpty(f.excludes)){var g=_.remove(this.signature.leaves,function(a){return _.includes(f.excludes,a.identifier)});_.forEach(g,function(a){_.unset(e.claims,a.claimPath)})}return this.filter=function(a){var b=_.cloneDeep(e);return _.remove(b.signature.leaves,function(b){return!_.includes(a,b.identifier)}),b.claims={},_.forEach(b.signature.leaves,function(a){_.set(b.claims,a.claimPath,_.get(e.claims,a.claimPath))}),b},this.requestAnchor=function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b){var c;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,anchorService.anchor(e.identifier,e.signature.merkleRoot,b);case 2:return c=a.sent,e.signature.anchor=c,a.abrupt("return",e);case 5:case"end":return a.stop();}},a,e)}));return function(){return a.apply(this,arguments)}}(),this.updateAnchor=_asyncToGenerator(regeneratorRuntime.mark(function a(){var b;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,anchorService.update(e.signature.anchor);case 2:return b=a.sent,e.signature.anchor=b,a.abrupt("return",e);case 5:case"end":return a.stop();}},a,e)})),this}module.exports=VerifiableCredentialBaseConstructor;