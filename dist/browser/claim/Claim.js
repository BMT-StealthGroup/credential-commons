"use strict";var _getIterator2=require("babel-runtime/core-js/get-iterator"),_getIterator3=_interopRequireDefault(_getIterator2),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_get2=require("babel-runtime/helpers/get"),_get3=_interopRequireDefault(_get2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2);function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}var _=require("lodash"),sjcl=require("sjcl"),_require=require("@identity.com/uca"),UserCollectableAttribute=_require.UserCollectableAttribute,definitions=require("./definitions"),_require2=require("../services"),services=_require2.services,validIdentifiers=_.map(definitions,function(a){return a.identifier});function getBaseIdentifiers(a){var b=/claim-cvc:(.*)\.(.*)-v\d*/,c=!0,d=b.exec(a);return null===d&&(d=_.split(a,":"),c=!1),{identifierComponents:d,isNewIdentifier:c}}function adaptIdentifierIfNeeded(a){var b=getBaseIdentifiers(a),c=b.isNewIdentifier,d=b.identifierComponents;if(!c&&!_.find(definitions,{identifier:a})){var e="claim-cvc:"+d[1]+"."+d[2]+"-v1",f=_.find(definitions,{identifier:e});if(f)return e;throw new Error(a+" is not defined")}return a}var Claim=function(a){function b(a,c,d){(0,_classCallCheck3.default)(this,b);var e=adaptIdentifierIfNeeded(a),f=(0,_possibleConstructorReturn3.default)(this,(b.__proto__||(0,_getPrototypeOf2.default)(b)).call(this,e,c,d,definitions));return f.initialize(e,c,d),f}return(0,_inherits3.default)(b,a),(0,_createClass3.default)(b,[{key:"initialize",value:function(a,c,d){if((0,_get3.default)(b.prototype.__proto__||(0,_getPrototypeOf2.default)(b.prototype),"initialize",this).call(this,a,c,d),!this.salt){var e=services.container.SecureRandom;this.salt=sjcl.codec.hex.fromBits(sjcl.hash.sha256.hash(e.wordWith(64)))}}},{key:"initializeAttestableValue",value:function(){var a=this,c=this.value,d=this.version?_.find(definitions,{identifier:this.identifier,version:this.version}):_.find(definitions,{identifier:this.identifier}),e=b.parseAttestableValue(c);if(1===e.length){this.timestamp=null,this.salt=e[0].salt;var f=e[0].value;this.value=_.includes(["null","undefined"],f)?null:f}else{for(var g={},h=function(c){var f=e[c].propertyName,h=f.split("."),i=h[h.length-2],j=i.substring(0,1).toUpperCase()+i.substring(1),k=h[h.length-1],l="cvc:"+j+":"+k,m=definitions.find(function(a){return a.identifier===l});m||(l=a.findDefinitionByAttestableValue(k,d)),g[f]=new b(l,{attestableValue:e[c].stringValue})},j=0;j<e.length;j+=1)h(j);this.value=g}}},{key:"getValidIdentifiers",value:function(){return validIdentifiers}},{key:"findDefinitionByAttestableValue",value:function(a,b){var c=!0,d=!1,e=void 0;try{for(var f,g=(0,_getIterator3.default)(b.type.properties);!(c=(f=g.next()).done);c=!0){var h=f.value,i=_.find(definitions,{identifier:h.type});if(i.type=UserCollectableAttribute.resolveType(i,definitions),!i.type.properties&&h.name===a)return h.type;if(i.type.properties)return this.findDefinitionByAttestableValue(a,i)}}catch(a){d=!0,e=a}finally{try{!c&&g.return&&g.return()}finally{if(d)throw e}}return null}},{key:"getAttestableValue",value:function(a){var b=this,c=getBaseIdentifiers(this.identifier),d=c.identifierComponents,e=d[2];return a&&(e=a+"."+e),0<=["String","Number","Boolean"].indexOf(this.type)?"urn:"+e+":"+this.salt+":"+this.value+"|":_.reduce(_.sortBy(_.keys(this.value)),function(a,c){return""+a+b.value[c].getAttestableValue(e)},"")}},{key:"getGlobalCredentialItemIdentifier",value:function(){return"claim-"+this.identifier+"-"+this.version}},{key:"getClaimRootPropertyName",value:function(){var a=getBaseIdentifiers(this.identifier),b=a.identifierComponents;return _.camelCase(b[1])}},{key:"getClaimPropertyName",value:function(){var a=getBaseIdentifiers(this.identifier),b=a.identifierComponents;return b[2]}},{key:"getClaimPath",value:function(){return b.getPath(this.identifier)}},{key:"getAttestableValues",value:function(){var a=this,b=[],c=_.find(definitions,{identifier:this.identifier,version:this.version});return(c.credentialItem||c.attestable)&&(b.push({identifier:this.identifier,value:this.getAttestableValue()}),"Object"===this.type&&_.forEach(_.keys(this.value),function(c){var d=a.value[c].getAttestableValues();_.reduce(d,function(a,b){return a.push(b)},b)})),b}}],[{key:"resolveType",value:function(a){return UserCollectableAttribute.resolveType(a,definitions)}},{key:"parseAttestableValue",value:function(a){var b=[],c=_.split(a.attestableValue,"|"),d=/^urn:(\w+(?:\.\w+)*):(\w+):(.+)/;if(_.each(c,function(a){var c=d.exec(a);if(c&&4===c.length){var e={propertyName:c[1],salt:c[2],value:c[3],stringValue:a};b.push(e)}}),c.length!==b.length&&c.length!==b.length+1)throw new Error("Invalid attestableValue");return b}},{key:"getPath",value:function(a){var b=getBaseIdentifiers(a),c=b.identifierComponents,d=_.camelCase(c[1]);return d+"."+c[2]}},{key:"getTypeName",value:function(a){if(_.isString(a.type)){if(_.includes(validIdentifiers,a.type)){var b=_.find(definitions,{identifier:a.type});return this.getTypeName(b)}return a.type}return"Object"}},{key:"getAllProperties",value:function(a,b){var c=this,d=_.find(definitions,{identifier:a}),e=[],f=UserCollectableAttribute.resolveType(d,definitions),g=_.isString(f)?_.find(definitions,{identifier:f}):d;if(g&&"Object"===this.getTypeName(g)){var h;if(g.type.properties)h=g.type.properties;else{var i=_.find(definitions,{identifier:g.type});h=UserCollectableAttribute.resolveType(i,definitions).properties}var j=void 0,k=getBaseIdentifiers(a),l=k.identifierComponents;j=b?_.includes(b,_.lowerCase(l[1]))?""+b:b+"."+_.lowerCase(l[1])+"."+l[2]:_.lowerCase(l[1])+"."+l[2],_.includes(["String","Number","Boolean"],""+h.type)?e.push(j+"."+h.name):_.forEach(h,function(a){var b=getBaseIdentifiers(a.type),d=b.isNewIdentifier,f=d?j+"."+a.name:j,g=c.getAllProperties(a.type,f);_.forEach(g,function(a){return e.push(a)})})}else if(b){var m=getBaseIdentifiers(d.identifier),n=m.identifierComponents,o=void 0;o=0<=b.indexOf(n[2])?""+b:b+"."+n[2],e.push(o)}else{var p=getBaseIdentifiers(a),q=p.identifierComponents,r=_.lowerCase(q[1])+"."+q[2];e.push(r)}return e}}]),b}(UserCollectableAttribute);function convertIdentifierToClassName(a){var b=getBaseIdentifiers(a),c=b.identifierComponents,d=c[1],e=_.upperFirst(_.camelCase(c[2]));return""+d+e}function mixinIdentifiers(a){return _.forEach(_.filter(definitions,function(a){return a.credentialItem}),function(a){var b=convertIdentifierToClassName(a.identifier),c={},d=a.identifier;c[b]=function(a,b){var c=new Claim(d,a,b);return c},_.mixin(Claim,c)}),a}module.exports={Claim:mixinIdentifiers(Claim),definitions:definitions,getBaseIdentifiers:getBaseIdentifiers};