"use strict";var _isInteger=require("babel-runtime/core-js/number/is-integer"),_isInteger2=_interopRequireDefault(_isInteger),_typeof2=require("babel-runtime/helpers/typeof"),_typeof3=_interopRequireDefault(_typeof2),_getIterator2=require("babel-runtime/core-js/get-iterator"),_getIterator3=_interopRequireDefault(_getIterator2),_slicedToArray2=require("babel-runtime/helpers/slicedToArray"),_slicedToArray3=_interopRequireDefault(_slicedToArray2),_entries=require("babel-runtime/core-js/object/entries"),_entries2=_interopRequireDefault(_entries);function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}var randomString=require("randomstring"),UCA=require("../../uca/UserCollectableAttribute"),ucaDefinitions=require("../../uca/definitions"),Type=require("type-of-is"),RandExp=require("randexp"),DRAFT="http://json-schema.org/draft-07/schema#",getPropertyNameFromDefinition=function(a){var b=-1<a.identifier.lastIndexOf(".")?a.identifier.lastIndexOf(".")+1:a.identifier.lastIndexOf(":")+1;return a.identifier.substring(b)},getPropertyFormat=function(a){var b=Type.string(a).toLowerCase();return"date"===b?"date-time":null},getPropertyType=function(a){var b=Type.string(a).toLowerCase();return"date"===b?"string":"regexp"===b?"string":"function"===b?"string":b},getUniqueKey=function(a,b){return b||[]},processObject=function a(b,c,d){var e=c;d&&e?e={properties:e}:(e=e||{},e.type=getPropertyType(b),e.properties=e.properties||{});var f=(0,_entries2.default)(b),g=!0,h=!1,i=void 0;try{for(var j,k=(0,_getIterator3.default)(f);!(g=(j=k.next()).done);g=!0){var l=j.value,m=(0,_slicedToArray3.default)(l,2),n=m[0],o=m[1],p=getPropertyType(o),q=getPropertyFormat(o);if(p="undefined"===p?"string":p,"object"===p)e.properties[n]=a(o,e.properties[n]);else if("array"===p)e.properties[n]=processArray(o,e.properties[n]);else if(e.properties[n]){var r=e.properties[n],s=Array.isArray(r.type);s&&0>r.type.indexOf(p)&&r.type.push(p),s||r.type===p||(r.type=[r.type,p])}else e.properties[n]={},e.properties[n].type="null"===p?["null","string"]:p,q&&(e.properties[n].format=q)}}catch(a){h=!0,i=a}finally{try{!g&&k.return&&k.return()}finally{if(h)throw i}}return d?e.properties:e},processArray=function a(b,c,d){var e=void 0,f=void 0,g=void 0,h=c;d&&h?h={items:h}:(h=h||{},h.type=getPropertyType(b),h.items=h.items||{},g=h.items.type||null);for(var i=0,j=b.length;i<j;i+=1){var k=getPropertyType(b[i]),l=getPropertyFormat(b[i]);if(g&&k!==g){h.items.oneOf=[],f=!0;break}else g=k,e=l}if(!f&&g?(h.items.type=g,e&&(h.items.format=e)):f&&"object"!==g&&(h.items={oneOf:[{type:g}],required:h.items.required}),"undefined"!=typeof h.items.oneOf||"object"===g)for(var m=0,n=b.length;m<n;m+=1){var o=b[m],p=getPropertyType(o),q=getPropertyFormat(o),r=void 0;if("object"===p?(h.items.properties&&(h.items.required=getUniqueKey(o,h.items.required)),r=processObject(o,f?{}:h.items.properties,!0)):"array"===p?r=a(o,f?{}:h.items.properties,!0):(r={},r.type=p,q&&(r.format=q)),f){var s=Type.string(o).toLowerCase(),t={};r.type||"object"!==s||(t.properties=r,t.type="object",r=t),h.items.oneOf.push(r)}else"object"===h.items.type&&(h.items.properties=r)}return d?h.items:h},process=function(a,b){var c=b,d=a.identifier,e=void 0,f={$schema:DRAFT};return"string"==typeof d?f.title=d:(c=d,d=void 0),f.type=Type.string(c).toLowerCase(),"object"===f.type&&(e=processObject(c),f.type=e.type,f.properties=e.properties),"array"===f.type&&(e=processArray(c),f.type=e.type,f.items=e.items,f.title&&(f.items.title=f.title,f.title+=" Set")),"undefined"!=typeof a&&null!==a&&(Array.isArray(a.required)?f.required=a.required:a.required&&(f.required=[getPropertyNameFromDefinition(a)]),"undefined"!=typeof a.minimum&&null!==a.minimum&&(a.exclusiveMinimum?f.exclusiveMinimum=a.minimum:f.minimum=a.minimum),"undefined"!=typeof a.maximum&&null!==a.maximum&&(a.exclusiveMaximum?f.exclusiveMaximum=a.maximum:f.maximum=a.maximum)),f.additionalProperties=!1,f},buildSampleJson=function(a){var b={};return b=makeJsonRecursion(a),b},makeJsonRecursion=function(a){var b={},c=UCA.getTypeName(a);if("object"===(0,_typeof3.default)(a.type)&&a.type.properties!==void 0)a.type.properties.forEach(function(a){b[a.name]=generateRandomValueForType(a.type)});else if("Object"!==c){var d=getPropertyNameFromDefinition(a);b[d]="undefined"!=typeof a.pattern&&null!==a.pattern?new RandExp(a.pattern).gen():generateRandomValueForType(a.type)}else b=generateRandomValueForType(a.type);return b},generateRandomNumberValueWithRange=function(a){var b=Math.floor,c=100*Math.random();if(null!==a){var d=a.exclusiveMinimum?1:0,e=a.exclusiveMaximum?-1:0;"undefined"!=typeof a.minimum&&null!==a.minimum&&"undefined"!=typeof a.maximum&&null!==a.maximum?((0,_isInteger2.default)(a.minimum)&&(c=b(a.minimum+d+Math.random()*(a.maximum+e))),c=a.minimum+Math.random()*a.maximum):"undefined"!=typeof a.minimum&&null!==a.minimum?((0,_isInteger2.default)(a.minimum)&&(c=b(a.minimum+d+100*Math.random())),c=a.minimum+100*Math.random()):"undefined"!=typeof a.maximum&&null!==a.maximum&&((0,_isInteger2.default)(a.maximum)&&(c=b(Math.random()*(a.maximum+e))),c=Math.random()*a.maximum)}return c},generateRandomValueForType=function(a){var b=null,c=a;return a.includes(":")&&(b=ucaDefinitions.find(function(b){return b.identifier===a}),null!==b&&(c=b.type)),"String"===c?randomString.generate(10):"Number"===c?generateRandomNumberValueWithRange(b):"Boolean"===c?1===Math.round(Math.random()):makeJsonRecursion(b)};module.exports={process:process,buildSampleJson:buildSampleJson};