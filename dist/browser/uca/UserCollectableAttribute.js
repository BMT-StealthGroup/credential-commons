"use strict";var _stringify=require("babel-runtime/core-js/json/stringify"),_stringify2=_interopRequireDefault(_stringify);function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}var _=require("lodash"),timestamp=require("unix-timestamp"),sjcl=require("sjcl"),SecureRandom=require("../SecureRandom"),definitions=require("./definitions"),validIdentifiers=_.map(definitions,function(a){return a.identifier});function isValueOfType(a,b){return"String"===b?_.isString(a):"Number"===b?_.isNumber(a):!("Boolean"!=b)&&_.isBoolean(a)}function isValid(a,b,c){return"String"===b?(!c.pattern||c.pattern.test(a))&&(!c.minimumLength||a.length>=c.minimumLength)&&(!c.maximumLength||a.length<=c.minimumLength):"Number"===b?((!_.isNil(c.minimum)&&c.exclusiveMinimum?a>c.minimum:a>=c.minimum)||_.isNil(c.minimum))&&((!_.isNil(c.maximum)&&c.exclusiveMaximum?a<c.maximum:a<=c.maximum)||_.isNil(c.maximum)):!("Boolean"!=b)&&_.isBoolean(a)}var getTypeName=function a(b){if(_.isString(b.type)){if(_.includes(validIdentifiers,b.type)){var c=_.find(definitions,{identifier:b.type});return a(c)}return b.type}return"Object"},resolveType=function a(b){var c=getTypeName(b);if("Object"!==c)return c;if(!_.isString(b.type))return b.type;var d=_.find(definitions,{identifier:b.type});return a(d)};function UCABaseConstructor(a,b,c){var d=this;if(this.timestamp=timestamp.now(),this.id=null,!_.includes(validIdentifiers,a))throw new Error(a+" is not defined");this.identifier=a;var e=c?_.find(definitions,{identifier:a,version:c}):_.find(definitions,{identifier:a});if(this.version=c||e.version,this.type=getTypeName(e),e.type=resolveType(e),isValueOfType(b,this.type)){if(!isValid(b,this.type,e))throw new Error((0,_stringify2.default)(b)+" is not valid for "+a);this.value=b,this.salt=sjcl.codec.hex.fromBits(sjcl.hash.sha256.hash(SecureRandom.wordWith(64)))}else if(_.isEmpty(e.type.properties))throw new Error((0,_stringify2.default)(b)+" is not valid for "+a);else{var f=_.reduce(e.type.required,function(a,c){return b[c]&&a},!0);if(!f)throw new Error("Missing required fields to "+a);var g=_.mapValues(_.keyBy(_.map(b,function(a,b){var c=_.find(e.type.properties,{name:b}),d=new UCABaseConstructor(c.type,a,c.version);return{key:b,value:d}}),"key"),"value");this.value=g}this.getAttestableValue=function(){switch(d.type){case"String":return"s:"+d.salt+":"+d.value;case"Number":return"n:"+d.salt+":"+_.padStart(d.value.toString(),8,"0");case"Boolean":return"b:"+d.salt+":"+d.value;default:return _.reduce(_.sortBy(_.keys(d.value)),function(a,b){return""+a+d.value[b].getAttestableValue()+"|"},"");}},this.getGlobalCredentialItemIdentifier=function(){return"uca-"+d.identifier+"-"+d.version},this.getClaimRootPropertyName=function(){var a=_.split(d.identifier,":");return _.lowerCase(a[1])},this.getClaimPropertyName=function(){var a=_.split(d.identifier,":");return a[2]},this.getClaimPath=function(){var a=_.split(d.identifier,":"),b=_.lowerCase(a[1]);return b+"."+a[2]},this.getAttestableValues=function(){var a=[],b=_.find(definitions,{identifier:d.identifier,version:d.version});return(b.credentialItem||b.attestable)&&(a.push({identifier:d.identifier,value:d.getAttestableValue()}),"Object"===d.type&&_.forEach(_.keys(d.value),function(b){var c=d.value[b].getAttestableValues();_.reduce(c,function(a,b){return a.push(b)},a)})),a},this.getPlainValue=function(a){var b={},c=[];switch(d.type){case"String":case"Number":case"Boolean":if(a)b[a]=d.value;else{if(!d.credentialItem)return d.value;b[d.identifier]=d.value}return b;default:return _.forEach(_.sortBy(_.keys(d.value)),function(a){c.push(d.value[a].getPlainValue(a))}),_.forEach(c,function(a){_.assign(b,a)}),b;}};var h=sjcl.codec.hex.fromBits(sjcl.hash.sha256.hash(this.getAttestableValue()));return this.id=this.version+":"+this.identifier+":"+h,this}var UCA=UCABaseConstructor;function convertIdentifierToClassName(a){var b=_.split(a,":"),c=b[1],d=_.upperFirst(_.camelCase(b[2]));return""+c+d}_.forEach(_.filter(definitions,function(a){return a.credentialItem}),function(a){var b=convertIdentifierToClassName(a.identifier),c={},d=a.identifier;c[b]=function(a,b){var c=new UCABaseConstructor(d,a,b);return c},_.mixin(UCA,c)}),UCA.getTypeName=getTypeName,UCA.resolveType=resolveType,module.exports=UCA;