"use strict";var _promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2);function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}var _require=require("lodash"),cloneDeep=_require.cloneDeep,_require2=require("chainauth"),Verifier=_require2.Verifier,tbsAttestationSubject=_require2.tbsAttestationSubject,Attester=_require2.Attester,attestationRequest=_require2.attestationRequest,bitgo=_require2.bitgo,attestationRevocation=_require2.attestationRevocation,assert=require("assert"),BitGo=bitgo.BitGo,_bitgo$bitcoin=bitgo.bitcoin,crypto=_bitgo$bitcoin.crypto,ECSignature=_bitgo$bitcoin.ECSignature,HDNode=_bitgo$bitcoin.HDNode;function CurrentCivicAnchor(a){var b=this;return this.config=a,this.pollService=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function a(){return _regenerator2.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:throw new Error("Not implemented");case 1:case"end":return a.stop();}},a,b)})),this.anchor=function(){var a=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function a(c,d,e){var f,g,h,i,j,k;return _regenerator2.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(f=e||{},g=f.keychain||b.config.keychain,h=f.passphrase||b.config.walletPassphrase,i=f.network||b.config.network||"testnet",g){a.next=6;break}throw new Error("Config Error, missing keychain.");case 6:if(h){a.next=8;break}throw new Error("Config Error, missing passphrase.");case 8:return j=attestationRequest({keychain:g,label:c,data:d,passphrase:h}),k=new Attester({accessToken:b.config.accessToken,walletId:b.config.walletId,walletPassphrase:b.config.walletPassphrase,network:i}),a.abrupt("return",k.tempAttest(j));case 11:case"end":return a.stop();}},a,b)}));return function(){return a.apply(this,arguments)}}(),this.update=function(){var a=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function a(c){var d,e;return _regenerator2.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if("temporary"!==c.type){a.next=6;break}return d=new Attester({accessToken:b.config.accessToken,walletId:b.config.walletId,walletPassphrase:b.config.walletPassphrase,network:c.network}),a.next=4,d.multiAttest({requests:[c]});case 4:return e=a.sent,a.abrupt("return",e[0]);case 6:return a.abrupt("return",b);case 7:case"end":return a.stop();}},a,b)}));return function(){return a.apply(this,arguments)}}(),this.verifySignature=function(a){var c=a.anchor.subject,d=b.verifySubjectSignature(c),e=cloneDeep(c);e.data=a.merkleRoot;var f=b.verifySubjectSignature(e);return d&&f},this.verifySubjectSignature=function(a){var b=crypto.sha256(tbsAttestationSubject(a)),c=ECSignature.fromDER(Buffer.from(a.signature,"hex"));return HDNode.fromBase58(a.pub).keyPair.verify(b,c)},this.verifyAttestation=function(){var a=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function a(c){var d,e,f;return _regenerator2.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if("permanent"!==c.anchor.type||c.anchor.subject.value){a.next=7;break}return d="testnet"===c.anchor.network?"test":"prod",e=new Verifier({env:d,coin:c.anchor.coin,accessToken:process.env.ACCESS_TOKEN,offline:!1}),a.next=5,e.verify(c.anchor);case 5:return f=a.sent,a.abrupt("return",f);case 7:return a.abrupt("return",!1);case 8:case"end":return a.stop();}},a,b)}));return function(){return a.apply(this,arguments)}}(),this.revokeAttestation=function(){var a=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function a(c){var d,e;return _regenerator2.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return d=[{prv:process.env.CIVIC_KEYCHAIN}],a.next=3,b.getWalletHandle(c.anchor,process.env.CLIENT_ACCESS_TOKEN);case 3:return e=a.sent,a.next=6,b.revokeAttestationWithWalletAndCosigner(e,c.anchor,d);case 6:return a.abrupt("return",b.verifyFundsSpent(c.anchor));case 7:case"end":return a.stop();}},a,b)}));return function(){return a.apply(this,arguments)}}(),this.isRevoked=function(){var a=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function a(c){return _regenerator2.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",b.verifyFundsSpent(c.anchor));case 1:case"end":return a.stop();}},a,b)}));return function(){return a.apply(this,arguments)}}(),this.verifyFundsSpent=function(){var a=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function a(c){var d,e,f,g=1<arguments.length&&void 0!==arguments[1]?arguments[1]:10;return _regenerator2.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return d=new Verifier({retries:0}),e=g,f=function a(){return!e||(e-=1,d.verify(c).then(new _promise2.default(function(a){return setTimeout(a,1e3*(0<e?1:0))})).then(a))},a.abrupt("return",f().then(assert.fail).catch(function(a){return"Error: Unspent not found in blockchain"===a.toString()}));case 4:case"end":return a.stop();}},a,b)}));return function(){return a.apply(this,arguments)}}(),this.revokeAttestationWithWalletAndCosigner=function(){var a=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function a(c,d,e){var f,g;return _regenerator2.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return f=attestationRevocation({attestation:d,keychains:e,amount:Attester.DUST_THRESHOLD_SATOSHIS+1}),g=f.revocation,a.next=3,c.submitTransaction({txHex:g});case 3:return a.abrupt("return",!0);case 4:case"end":return a.stop();}},a,b)}));return function(){return a.apply(this,arguments)}}(),this.getWalletHandle=function(){var a=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function a(c,d){var e,f,g;return _regenerator2.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return e="testnet"===c.network?"test":"prod",f=new BitGo({accessToken:d,env:e}),g=c.walletId,a.abrupt("return",f.coin(c.coin).wallets().get({id:g}));case 4:case"end":return a.stop();}},a,b)}));return function(){return a.apply(this,arguments)}}(),this}module.exports={CurrentCivicAnchor:CurrentCivicAnchor};